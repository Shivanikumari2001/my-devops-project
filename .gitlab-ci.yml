# GitLab CI/CD Configuration for Monorepo
# This file handles all three services: api-gateway, service1, service2

stages:
  - test
  - build
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"

# ============================================
# API GATEWAY
# ============================================

api-gateway:test:
  stage: test
  image: node:20-alpine
  before_script:
    - cd api-gateway
    - npm ci
  script:
    - npm run lint || echo "Lint skipped"
    - npm run test || echo "Tests skipped"
  only:
    - merge_requests
    - main
    - master
    - develop
  allow_failure: true  # Don't fail pipeline if tests fail

api-gateway:build:
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - cd api-gateway
    - |
      if [ -z "$CI_REGISTRY" ]; then
        docker login -u $DOCKER_HUB_USER -p $DOCKER_HUB_TOKEN
        export IMAGE_REGISTRY=""
      else
        export IMAGE_REGISTRY="$CI_REGISTRY/"
        docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
      fi
  script:
    - export IMAGE_TAG=${CI_COMMIT_SHORT_SHA:-latest}
    - export IMAGE_NAME=wrakash/sky-gateway
    - export FULL_IMAGE_NAME=${IMAGE_REGISTRY}${IMAGE_NAME}:${IMAGE_TAG}
    - echo "Building Docker image: $FULL_IMAGE_NAME"
    - docker build -t $FULL_IMAGE_NAME .
    - docker tag $FULL_IMAGE_NAME ${IMAGE_REGISTRY}${IMAGE_NAME}:latest
    - docker push $FULL_IMAGE_NAME
    - docker push ${IMAGE_REGISTRY}${IMAGE_NAME}:latest
  only:
    - main
    - master
    - develop
    - tags

# ============================================
# SERVICE1
# ============================================

service1:test:
  stage: test
  image: node:20-alpine
  before_script:
    - cd service1
    - apk add --no-cache openssl
    - npm ci
    - npx prisma generate || echo "Prisma generate skipped"
  script:
    - npm run lint || echo "Lint skipped"
    - npm run test || echo "Tests skipped"
  only:
    - merge_requests
    - main
    - master
    - develop
  allow_failure: true

service1:build:
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - cd service1
    - |
      if [ -z "$CI_REGISTRY" ]; then
        docker login -u $DOCKER_HUB_USER -p $DOCKER_HUB_TOKEN
        export IMAGE_REGISTRY=""
      else
        export IMAGE_REGISTRY="$CI_REGISTRY/"
        docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
      fi
  script:
    - export IMAGE_TAG=${CI_COMMIT_SHORT_SHA:-latest}
    - export IMAGE_NAME=wrakash/sky-service1
    - export FULL_IMAGE_NAME=${IMAGE_REGISTRY}${IMAGE_NAME}:${IMAGE_TAG}
    - echo "Building Docker image: $FULL_IMAGE_NAME"
    - docker build -t $FULL_IMAGE_NAME .
    - docker tag $FULL_IMAGE_NAME ${IMAGE_REGISTRY}${IMAGE_NAME}:latest
    - docker push $FULL_IMAGE_NAME
    - docker push ${IMAGE_REGISTRY}${IMAGE_NAME}:latest
  only:
    - main
    - master
    - develop
    - tags

# ============================================
# SERVICE2
# ============================================

service2:test:
  stage: test
  image: node:20-alpine
  before_script:
    - cd service2
    - apk add --no-cache openssl
    - npm ci
    - npx prisma generate || echo "Prisma generate skipped"
  script:
    - npm run lint || echo "Lint skipped"
    - npm run test || echo "Tests skipped"
  only:
    - merge_requests
    - main
    - master
    - develop
  allow_failure: true

service2:build:
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - cd service2
    - |
      if [ -z "$CI_REGISTRY" ]; then
        docker login -u $DOCKER_HUB_USER -p $DOCKER_HUB_TOKEN
        export IMAGE_REGISTRY=""
      else
        export IMAGE_REGISTRY="$CI_REGISTRY/"
        docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
      fi
  script:
    - export IMAGE_TAG=${CI_COMMIT_SHORT_SHA:-latest}
    - export IMAGE_NAME=wrakash/sky-service2
    - export FULL_IMAGE_NAME=${IMAGE_REGISTRY}${IMAGE_NAME}:${IMAGE_TAG}
    - echo "Building Docker image: $FULL_IMAGE_NAME"
    - docker build -t $FULL_IMAGE_NAME .
    - docker tag $FULL_IMAGE_NAME ${IMAGE_REGISTRY}${IMAGE_NAME}:latest
    - docker push $FULL_IMAGE_NAME
    - docker push ${IMAGE_REGISTRY}${IMAGE_NAME}:latest
  only:
    - main
    - master
    - develop
    - tags

